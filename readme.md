# 账单转换器

本项目用于导入支付宝、微信、银行信用卡等账单数据，并对账单数据进行标准化处理，转换成适合导入 MoneyPro app 的账单。

## 项目介绍

这是一个基于 Python 的账单转换工具，可以将支付宝、微信、银行信用卡等账单数据转换为 MoneyPro 支持的格式。该工具具有以下特点：

1. 支持多种账单格式解析（支付宝CSV、微信Excel、银行PDF等）
2. 智能分类系统，基于交易描述自动分类
3. 跨平台转账识别与去重
4. 投资类交易过滤
5. 工资和公积金收入自动识别

## 项目结构

```
bill_converter/
├── __init__.py             # 包初始化文件
├── cli.py                  # 命令行接口
├── main.py                 # 主程序入口
├── config.py               # 配置文件
├── alipay/                 # 支付宝账单处理模块
│   ├── __init__.py
│   └── parser.py           # 支付宝账单解析器
├── wechat/                 # 微信账单处理模块
│   ├── __init__.py
│   └── parser.py           # 微信账单解析器
├── bank/                   # 银行账单处理模块
│   ├── __init__.py
│   └── parser.py           # 银行账单解析器
├── moneypro/               # MoneyPro格式导出模块
│   ├── __init__.py
│   └── exporter.py         # MoneyPro格式导出器
├── utils/                  # 工具模块
│   ├── __init__.py
│   ├── converter.py        # 通用转换器
│   └── deduplicator.py     # 去重工具
├── data/                   # 数据文件
│   └── category_keywords.json  # 分类关键词
└── tests/                  # 测试模块
    ├── __init__.py
    └── test_alipay_parser.py   # 支付宝解析器测试
```

## 安装说明

1. 克隆项目代码：
   ```
   git clone <项目地址>
   cd billing-converter
   ```

2. 创建并激活虚拟环境：
   ```
   python3 -m venv venv
   source venv/bin/activate  # Linux/Mac
   # 或 venv\Scripts\activate  # Windows
   ```

3. 安装依赖：
   ```
   pip install -r requirements.txt
   ```

## 使用说明

### 命令行使用

1. 转换支付宝账单：
   ```
   python -m bill_converter.cli alipay -i <支付宝账单文件路径> -o <输出文件路径>
   ```

2. 转换微信账单：
   ```
   python -m bill_converter.cli wechat -i <微信账单文件路径> -o <输出文件路径>
   ```

3. 转换银行账单：
   ```
   python -m bill_converter.cli bank -i <银行账单文件路径> -o <输出文件路径> --bank <银行类型>
   ```

### 批量处理

使用主程序进行批量处理：
```
python bill_converter/main.py
```

程序会自动处理以下目录中的账单文件：
- `原始账单/alipay_record_*.csv` - 支付宝账单
- `原始账单/微信支付账单*.xlsx` - 微信账单
- `原始账单/招商银行*.pdf` - 招商银行账单

处理后的文件将保存在 `output/` 目录中。

### 人工维护说明

#### 分类关键词维护

分类系统基于关键词匹配实现，如需添加新的分类或修改现有分类关键词，请编辑 `bill_converter/data/category_keywords.json` 文件：

1. 添加新分类：
   ```json
   "新分类名": {
     "keywords": ["关键词1", "关键词2"],
     "word_dict": ["词汇1", "词汇2"]
   }
   ```

2. 修改现有分类：
   - `keywords`：用于直接匹配交易描述中的关键词
   - `word_dict`：用于分词匹配的词汇表

#### 转账对识别维护

转账对识别基于交易对方名称的相似性判断，如需调整相似性判断规则，请修改 `bill_converter/utils/deduplicator.py` 中的 `_find_similar_agents` 方法。

#### 过滤规则维护

如需调整各类账单的过滤规则，请修改对应解析器中的 `_apply_filters` 方法：
- 支付宝：`bill_converter/alipay/parser.py`
- 微信：`bill_converter/wechat/parser.py`
- 银行：`bill_converter/bank/parser.py`

## 账单解析规则

### 过滤逻辑

- 支付宝账单 过滤【收/支】类型为不计收支，因其为内部交易订单，不需要计入账单
- 支付宝账单 过滤花呗还款、信用卡还款等内部转账记录
- 微信账单 过滤同一交易对象的一对支出和收入转账记录
- 银行账单 过滤投资类交易记录（如朝朝宝、理财产品等）
- 银行账单 过滤信用卡还款等内部转账记录
- 所有账单 最后对所有账单进行二次过滤：因存在支付宝账单用银行卡支付的情况，导致同一笔订单记录两次，可根据付款时间、金额是否相同进行去重判断，优先保留支付宝或微信的账单；另支付宝、微信、银行之间的相互转账的两条交易记录均需过滤

### 类别转换逻辑

因支付宝/微信等账单的类型无法判断账单的场景，需要基于商品名称、交易对方、商家等列对交易进行分类

#### MoneyPro 已有的分类
- 住宅
- 食品
- 杂货
- 服装
- 个人
- 教育
- 娱乐
- iTunes
- 债务
- 日常开支
- 保险
- 税费
- 杂项支出
- 交通
- 订阅
- 读书
- 数码
- 亲属
- 投资亏损
- 旅游
- 其他
- 工资
- 住房公积金

#### 转换逻辑
1. 优先搜索互联网上是否有成熟的分类训练模型，可以在本地对账单明细进行分类训练
2. 无法基于算法训练，则基于以下关键词识别逻辑：
2.1 交易对方和商品名称关键词包含 ('淘宝闪购','肯德基','食品','霸王茶姬')等明显是食品行业品牌或食品名称，归为食品
2.2 交易对方和商品名称关键词包含 ('耐克')等明显是服装行业品牌或服装名称，归为服装
2.3 交易对方和商品名称关键词包含 ('高德打车','滴滴打车')等明显是交通行业品牌或交通名称，归为交通
2.4 交易对方为a.k.a. 小黄蜂，归类为亲属
2.5 交易对方和商品名称关键词包含 ('工资','代发工资')等明显是工资收入，归为工资
2.6 交易对方和商品名称关键词包含 ('住房公积\\金','住房公积金','公积金','汇入汇款')等明显是住房公积\\金收入，归为住房公积金
2.7 无法识别，归为其他